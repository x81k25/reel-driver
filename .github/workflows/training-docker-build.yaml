name: Training Docker Build

on:
  push:
    branches: [ dev, stg, main ]
  pull_request:
    branches: [ dev, stg, main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  training-docker-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      run: |
        # Generate tags based on branch/PR
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "TAG=pr-${{ github.event.number }}" >> $GITHUB_ENV
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "TAG=main" >> $GITHUB_ENV
        else
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "TAG=${BRANCH_NAME}" >> $GITHUB_ENV
        fi

    # ===================
    # CPU Base Image
    # ===================
    - name: Build and push CPU base training image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./containerization/dockerfile.base_training
        push: true
        tags: |
          ${{ env.IMAGE_PREFIX }}/reel-driver-training-base-cpu:${{ env.TAG }}
          ${{ env.IMAGE_PREFIX }}/reel-driver-training-base-cpu:sha-${{ github.sha }}
        cache-from: type=gha,scope=base-cpu
        cache-to: type=gha,mode=max,scope=base-cpu

    # ===================
    # GPU Base Image
    # ===================
    - name: Build and push GPU base training image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./containerization/dockerfile.base_training_gpu
        push: true
        tags: |
          ${{ env.IMAGE_PREFIX }}/reel-driver-training-base-gpu:${{ env.TAG }}
          ${{ env.IMAGE_PREFIX }}/reel-driver-training-base-gpu:sha-${{ github.sha }}
        cache-from: type=gha,scope=base-gpu
        cache-to: type=gha,mode=max,scope=base-gpu

    # ===================
    # CPU Service Images
    # ===================
    - name: Build and push CPU service images
      run: |
        set -e
        echo "Building CPU service images..."

        services=(
          "feature_engineering_cpu:reel-driver-feature-engineering-cpu"
          "model_training_cpu:reel-driver-model-training-cpu"
        )

        for service_info in "${services[@]}"; do
          IFS=':' read -r dockerfile service_name <<< "$service_info"
          echo "Building ${service_name}..."

          docker buildx build \
            --build-arg BASE_IMAGE=${{ env.IMAGE_PREFIX }}/reel-driver-training-base-cpu:${{ env.TAG }} \
            --file ./containerization/dockerfile.${dockerfile} \
            --tag ${{ env.IMAGE_PREFIX }}/${service_name}:${{ env.TAG }} \
            --tag ${{ env.IMAGE_PREFIX }}/${service_name}:sha-${GITHUB_SHA:0:8} \
            --push \
            --cache-from type=gha,scope=${service_name} \
            --cache-to type=gha,mode=max,scope=${service_name} \
            .
        done

    # ===================
    # GPU Service Images
    # ===================
    - name: Build and push GPU service images
      run: |
        set -e
        echo "Building GPU service images..."

        services=(
          "feature_engineering_gpu:reel-driver-feature-engineering-gpu"
          "model_training_gpu:reel-driver-model-training-gpu"
        )

        for service_info in "${services[@]}"; do
          IFS=':' read -r dockerfile service_name <<< "$service_info"
          echo "Building ${service_name}..."

          docker buildx build \
            --build-arg BASE_IMAGE=${{ env.IMAGE_PREFIX }}/reel-driver-training-base-gpu:${{ env.TAG }} \
            --file ./containerization/dockerfile.${dockerfile} \
            --tag ${{ env.IMAGE_PREFIX }}/${service_name}:${{ env.TAG }} \
            --tag ${{ env.IMAGE_PREFIX }}/${service_name}:sha-${GITHUB_SHA:0:8} \
            --push \
            --cache-from type=gha,scope=${service_name} \
            --cache-to type=gha,mode=max,scope=${service_name} \
            .
        done

    - name: Report build summary
      if: always()
      run: |
        echo "## Training Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Tag: ${{ env.TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "- Total build time: $((SECONDS / 60)) minutes $((SECONDS % 60)) seconds" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Base Images:" >> $GITHUB_STEP_SUMMARY
        echo "- reel-driver-training-base-cpu" >> $GITHUB_STEP_SUMMARY
        echo "- reel-driver-training-base-gpu" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### CPU Service Images:" >> $GITHUB_STEP_SUMMARY
        echo "- reel-driver-feature-engineering-cpu" >> $GITHUB_STEP_SUMMARY
        echo "- reel-driver-model-training-cpu" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### GPU Service Images:" >> $GITHUB_STEP_SUMMARY
        echo "- reel-driver-feature-engineering-gpu" >> $GITHUB_STEP_SUMMARY
        echo "- reel-driver-model-training-gpu" >> $GITHUB_STEP_SUMMARY
