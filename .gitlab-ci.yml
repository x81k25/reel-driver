stages:
  - test
  - build-base
  - build-services
  - deploy-test

variables:
  API_IMAGE: "${CI_REGISTRY_IMAGE}/api"
  BASE_TRAINING_CPU: "${CI_REGISTRY_IMAGE}/training-base-cpu"
  BASE_TRAINING_GPU: "${CI_REGISTRY_IMAGE}/training-base-gpu"
  FEATURE_ENG_CPU: "${CI_REGISTRY_IMAGE}/feature-engineering-cpu"
  FEATURE_ENG_GPU: "${CI_REGISTRY_IMAGE}/feature-engineering-gpu"
  MODEL_TRAINING_CPU: "${CI_REGISTRY_IMAGE}/model-training-cpu"
  MODEL_TRAINING_GPU: "${CI_REGISTRY_IMAGE}/model-training-gpu"

# Test stage
test:
  stage: test
  tags:
    - k8s
    - docker
  image: docker.io/astral/uv:python3.12-bookworm-slim
  before_script:
    - uv sync --all-extras
  script:
    - uv run pytest tests/training/test_model_training_unit.py -v --tb=short --confcutdir=tests/training
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

# Kaniko build template
.kaniko-build:
  tags:
    - k8s
    - docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

# API image build
build-api:
  extends: .kaniko-build
  stage: build-services
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.api"
      --destination "${API_IMAGE}:${CI_COMMIT_REF_NAME}"
      --destination "${API_IMAGE}:sha-${CI_COMMIT_SHORT_SHA}"

# Base training image (CPU)
build-base-training-cpu:
  extends: .kaniko-build
  stage: build-base
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.base_training"
      --destination "${BASE_TRAINING_CPU}:${CI_COMMIT_REF_NAME}"
      --destination "${BASE_TRAINING_CPU}:sha-${CI_COMMIT_SHORT_SHA}"

# Base training image (GPU)
build-base-training-gpu:
  extends: .kaniko-build
  stage: build-base
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.base_training_gpu"
      --destination "${BASE_TRAINING_GPU}:${CI_COMMIT_REF_NAME}"
      --destination "${BASE_TRAINING_GPU}:sha-${CI_COMMIT_SHORT_SHA}"

# Feature engineering (CPU) - depends on base
build-feature-engineering-cpu:
  extends: .kaniko-build
  stage: build-services
  needs:
    - build-base-training-cpu
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.feature_engineering_cpu"
      --build-arg "BASE_IMAGE=${BASE_TRAINING_CPU}:${CI_COMMIT_REF_NAME}"
      --destination "${FEATURE_ENG_CPU}:${CI_COMMIT_REF_NAME}"
      --destination "${FEATURE_ENG_CPU}:sha-${CI_COMMIT_SHORT_SHA}"

# Feature engineering (GPU) - depends on base
build-feature-engineering-gpu:
  extends: .kaniko-build
  stage: build-services
  needs:
    - build-base-training-gpu
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.feature_engineering_gpu"
      --build-arg "BASE_IMAGE=${BASE_TRAINING_GPU}:${CI_COMMIT_REF_NAME}"
      --destination "${FEATURE_ENG_GPU}:${CI_COMMIT_REF_NAME}"
      --destination "${FEATURE_ENG_GPU}:sha-${CI_COMMIT_SHORT_SHA}"

# Model training (CPU) - depends on base
build-model-training-cpu:
  extends: .kaniko-build
  stage: build-services
  needs:
    - build-base-training-cpu
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.model_training_cpu"
      --build-arg "BASE_IMAGE=${BASE_TRAINING_CPU}:${CI_COMMIT_REF_NAME}"
      --destination "${MODEL_TRAINING_CPU}:${CI_COMMIT_REF_NAME}"
      --destination "${MODEL_TRAINING_CPU}:sha-${CI_COMMIT_SHORT_SHA}"

# Model training (GPU) - depends on base
build-model-training-gpu:
  extends: .kaniko-build
  stage: build-services
  needs:
    - build-base-training-gpu
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/containerization/dockerfile.model_training_gpu"
      --build-arg "BASE_IMAGE=${BASE_TRAINING_GPU}:${CI_COMMIT_REF_NAME}"
      --destination "${MODEL_TRAINING_GPU}:${CI_COMMIT_REF_NAME}"
      --destination "${MODEL_TRAINING_GPU}:sha-${CI_COMMIT_SHORT_SHA}"

# Deploy-test template
.deploy-test:
  stage: deploy-test
  tags:
    - k8s
    - docker
  image: alpine/k8s:1.28.3
  needs:
    - build-api
  variables:
    NAMESPACE: "ai-ml"
    SERVICE_PORT: "8000"
  before_script:
    - apk add --no-cache bash jq
  script:
    - echo "Restarting deployment to pull new image..."
    - kubectl rollout restart deployment/${DEPLOYMENT} -n ${NAMESPACE}

    - echo "Waiting for rollout to complete..."
    - kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=180s

    - echo "Waiting for pod to be ready..."
    - |
      SERVICE_URL="http://${SERVICE_HOST}:${SERVICE_PORT}"
      for i in $(seq 1 30); do
        HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/reel-driver/health" || echo "000")
        if [ "$HEALTH" = "200" ]; then
          echo "Health check passed!"
          break
        fi
        echo "Health check attempt $i: HTTP $HEALTH, waiting..."
        sleep 5
      done
      if [ "$HEALTH" != "200" ]; then
        echo "Health check failed after 30 attempts"
        exit 1
      fi

    - echo "Running e2e tests..."
    - chmod +x tests/test_api_endpoints.sh
    - |
      if ! ./tests/test_api_endpoints.sh ci; then
        echo "Tests failed! Rolling back deployment..."
        kubectl rollout undo deployment/${DEPLOYMENT} -n ${NAMESPACE}
        kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=120s
        echo "Rollback complete."
        exit 1
      fi
      echo "All tests passed!"

# Deploy to dev and run e2e tests, rollback on failure
deploy-test-dev:
  extends: .deploy-test
  resource_group: reel-driver-dev
  variables:
    DEPLOYMENT: "reel-driver-dev"
    SERVICE_HOST: "reel-driver-dev.ai-ml.svc.cluster.local"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

# Deploy to stg and run e2e tests, rollback on failure
deploy-test-stg:
  extends: .deploy-test
  resource_group: reel-driver-stg
  variables:
    DEPLOYMENT: "reel-driver-stg"
    SERVICE_HOST: "reel-driver-stg.ai-ml.svc.cluster.local"
  rules:
    - if: $CI_COMMIT_BRANCH == "stg"

# Deploy to prod and run e2e tests, rollback on failure
deploy-test-prod:
  extends: .deploy-test
  resource_group: reel-driver-prod
  variables:
    DEPLOYMENT: "reel-driver-prod"
    SERVICE_HOST: "reel-driver-prod.ai-ml.svc.cluster.local"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
